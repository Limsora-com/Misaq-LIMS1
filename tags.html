<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Advanced QC Pharmaceutical Label Generator</title>
    <style>
        /* General Page Styles */
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f4f4f4;
            color: #333;
        }

        .container {
            max-width: 1000px;
            margin: auto;
            padding: 25px;
            background-color: #fff;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            border-top: 5px solid;
            transition: border-color: 0.4s ease;
        }

        h1, h2 { text-align: center; transition: color 0.4s ease; }
        h1 { color: #2c3e50; }
        h2 { border-bottom: 2px solid #ecf0f1; padding-bottom: 10px; margin-top: 30px;}
        hr { border: 1px solid #eee; margin: 30px 0; }

        /* --- Dynamic Theme --- */
        .container.theme-released { border-color: #28a745; }
        .container.theme-released h2 { color: #28a745; }
        .container.theme-rejected { border-color: #dc3545; }
        .container.theme-rejected h2 { color: #dc3545; }
        .container.theme-sampled { border-color: #007bff; }
        .container.theme-sampled h2 { color: #007bff; }

        /* Form Styles */
        .form-section { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px; margin-bottom: 20px; }
        .form-group { display: flex; flex-direction: column; }
        label { margin-bottom: 8px; font-weight: bold; font-size: 14px; }
        input, select { padding: 10px; border: 1px solid #ccc; border-radius: 4px; font-size: 14px; }
        select[multiple] { height: 120px; }
        input[type="file"] { padding: 3px; }
        #logo-preview { max-width: 150px; max-height: 60px; border: 1px solid #ccc; padding: 5px; border-radius: 4px; margin-top: 5px; }
        
        .button-container { text-align: center; margin-top: 30px; }
        button { padding: 12px 25px; border: none; border-radius: 5px; color: white; cursor: pointer; margin: 0 5px; font-size: 16px; font-weight: bold; transition: background-color 0.3s; }
        #generate-tags { padding: 12px 30px; font-size: 18px; }
        
        .container.theme-released #generate-tags { background-color: #28a745; }
        .container.theme-released #generate-tags:hover { background-color: #218838; }
        .container.theme-rejected #generate-tags { background-color: #dc3545; }
        .container.theme-rejected #generate-tags:hover { background-color: #c82333; }
        .container.theme-sampled #generate-tags { background-color: #007bff; }
        .container.theme-sampled #generate-tags:hover { background-color: #0056b3; }
        
        #btn-save-history { background-color: #17a2b8; }
        #btn-load-history { background-color: #6c757d; }
        #btn-delete-history { background-color: #e55353; }

        .hidden { display: none; }

        /* --- Print Styles (Calibrated for 6 tags on A4) --- */
        #print-area { display: none; }

        @media print {
            body.is-printing .no-print { display: none !important; }
            body.is-printing #print-area { display: block !important; }

            .print-container {
                display: grid;
                grid-template-columns: 1fr 1fr;
                grid-template-rows: repeat(3, 1fr);
                gap: 5mm;
                padding: 10mm;
                width: 210mm;
                height: 297mm;
                box-sizing: border-box;
            }
            .tag {
                border: 2.5px solid #000;
                padding: 4mm;
                box-sizing: border-box;
                page-break-inside: avoid;
                font-size: 9pt;
                display: flex;
                flex-direction: column;
                justify-content: space-between;
            }
            .tag-header { display: flex; justify-content: space-between; align-items: flex-start; border-bottom: 1.5px solid #000; padding-bottom: 6px; margin-bottom: 6px; }
            .tag-header .logo-area img { width: 65px; height: auto; }
            .tag-header .title-block { text-align: center; flex-grow: 1; padding: 0 5px; }
            .tag-header .title-block h3 { margin: 0; font-size: 14pt; font-weight: bold; }
            .tag-header .title-block .subtitle { margin: 0; font-size: 8pt; color: #333; }
            .tag-header .sop-block { text-align: right; font-size: 8pt; min-width: 75px; white-space: nowrap; }
            .tag-body { display: grid; grid-template-columns: 1fr 1fr; gap: 4px 12px; font-size: 8.5pt; }
            .tag-body .field { display: flex; align-items: baseline; }
            .tag-body .field-label { font-weight: bold; margin-right: 5px; white-space: nowrap; }
            .tag-body .field-value { border-bottom: 1px dotted #000; width: 100%; min-height: 12px; }
            .tag-body .remarks-field { grid-column: 1 / -1; }
            .tag-footer { margin-top: auto; padding-top: 10px; display: flex; justify-content: flex-start; font-size: 8.5pt; border-top: 1px solid #000; }
        }
    </style>
</head>
<body>

    <div id="main-container" class="container no-print">
        <h1>Advanced QC Pharmaceutical Label Generator</h1>
        
        <h2>Company Details (Saved Locally)</h2>
        <div class="form-section">
            <div class="form-group"><label for="company-name">Company Name:</label><input type="text" id="company-name" placeholder="Enter your company name"></div>
            <div class="form-group"><label for="logo-upload">Company Logo:</label><input type="file" id="logo-upload" accept="image/*"></div>
            <div class="form-group"><label>Logo Preview:</label><img id="logo-preview" src="data:image/gif;base64,R0lGODlhAQABAAD/ACwAAAAAAQABAAACADs=" alt="Logo Preview"></div>
        </div>
        <hr>

        <h2>History (Synced Across Devices)</h2>
        <div class="form-section">
             <div class="form-group">
                <label for="history-select">Load Saved Entry:</label>
                <select id="history-select"><option>Loading history...</option></select>
            </div>
            <div class="form-group" style="flex-direction: row; align-items: flex-end; gap: 10px;">
                <button id="btn-load-history" title="Load the selected entry from the dropdown">Load from History</button>
                <button id="btn-save-history" title="Save the current form data to history">Save to History</button>
                <button id="btn-delete-history" title="Delete the selected entry from the dropdown">Delete Selected</button>
            </div>
        </div>
        <hr>

        <div class="form-section">
            <div class="form-group">
                <label for="label-type">Select Label Type:</label>
                <select id="label-type">
                    <option value="raw-material">Raw Material</option>
                    <option value="packing-material">Packing Material</option>
                    <option value="finished-product">In-Process / Finished Product</option>
                </select>
            </div>
            <div class="form-group">
                <label for="tag-status">Select Status:</label>
                <select id="tag-status">
                    <option value="released">Released</option>
                    <option value="rejected">Rejected</option>
                    <option value="sampled" id="sampled-option">Sampled</option>
                </select>
            </div>
            <div class="form-group">
                <label for="total-container-count">Total # of Containers:</label>
                <input type="number" id="total-container-count" min="1" value="6" required>
            </div>
            <div class="form-group">
                <label for="tags-to-print">Container #s to Print:</label>
                <input type="text" id="tags-to-print" placeholder="e.g., 1-5, 8, 12">
            </div>
        </div>

        <!-- Raw Material Form -->
        <div id="raw-material-form" class="form-wrapper">
            <h2>Raw Material Details</h2>
            <div class="form-section" style="grid-template-columns: repeat(3, 1fr);">
                <div class="form-group"><label for="rm-sop-approved">Release Doc No:</label><input type="text" id="rm-sop-approved" class="sop-input" value="MP/QC/SOP/002/L"></div>
                <div class="form-group"><label for="rm-sop-rejected">Reject Doc No:</label><input type="text" id="rm-sop-rejected" class="sop-input" value="MP/QC/SOP/002/I"></div>
                <div class="form-group"><label for="rm-sop-sampled">Sampled Doc No:</label><input type="text" id="rm-sop-sampled" class="sop-input" value="MP/QC/SOP/002/M"></div>
            </div>
            <div class="form-section">
                <div class="form-group"><label for="rm-qc-no">QC #:</label><input type="text" id="rm-qc-no" class="history-field"></div>
                <div class="form-group"><label for="rm-product-name">Product Name:</label><input type="text" id="rm-product-name" class="history-field"></div>
                <div class="form-group"><label for="rm-batch-no">Batch #:</label><input type="text" id="rm-batch-no" class="history-field"></div>
                <div class="form-group"><label for="rm-mfg-date">MFG Date:</label><input type="text" id="rm-mfg-date" class="history-field" value="N/A"></div>
                <div class="form-group"><label for="rm-exp-date">EXP. Date:</label><input type="text" id="rm-exp-date" class="history-field"></div>
                <div class="form-group"><label for="rm-batch-size">Batch Size:</label><input type="text" id="rm-batch-size" class="history-field"></div>
                <div class="form-group"><label for="rm-test-date">Test Date:</label><input type="date" id="rm-test-date" class="history-field"></div>
                <div class="form-group"><label for="rm-release-date">Release Date:</label><input type="date" id="rm-release-date" class="history-field"></div>
                <div class="form-group"><label for="rm-manufacturer">Manufacturer:</label><input type="text" id="rm-manufacturer" class="history-field"></div>
                <div class="form-group"><label for="rm-remarks">Remarks:</label><input type="text" id="rm-remarks" class="remarks-input history-field"></div>
            </div>
            <div class="form-section">
                <div class="form-group">
                    <label for="rm-params-select">Select Test Parameters:</label>
                    <select id="rm-params-select" multiple class="history-field">
                        <option value="Appearance">Appearance</option>
                        <option value="Identification">Identification</option>
                        <option value="Assay">Assay</option>
                        <option value="Assay on anhydrous basis">Assay on anhydrous basis</option>
                        <option value="Assay on as is basis">Assay on as is basis</option>
                        <option value="Assay on dried basis">Assay on dried basis</option>
                        <option value="Loss on drying">Loss on drying</option>
                        <option value="Heavy metals">Heavy metals</option>
                        <option value="Residue on ignition">Residue on ignition</option>
                    </select>
                </div>
                <div id="rm-dynamic-params-container" class="form-group" style="gap: 15px;">
                    <!-- Dynamic RM input fields will be generated here -->
                </div>
            </div>
        </div>

        <!-- Packing Material Form -->
        <div id="packing-material-form" class="form-wrapper hidden">
            <h2>Packing Material Details</h2>
            <div class="form-section">
                <div class="form-group"><label for="pm-sop-approved">Release Doc No:</label><input type="text" id="pm-sop-approved" class="sop-input" value="MP/QC/SOP/002/J"></div>
                <div class="form-group"><label for="pm-sop-rejected">Reject Doc No:</label><input type="text" id="pm-sop-rejected" class="sop-input" value="MP/QC/SOP/002/K"></div>
            </div>
             <div class="form-section">
                <div class="form-group"><label for="pm-qc-no">QC #:</label><input type="text" id="pm-qc-no" class="history-field"></div>
                <div class="form-group"><label for="pm-item-name">Item Name:</label><input type="text" id="pm-item-name" class="history-field"></div>
                <div class="form-group"><label for="pm-batch-lot-no">Batch Lot #:</label><input type="text" id="pm-batch-lot-no" class="history-field"></div>
                <div class="form-group"><label for="pm-total-qty">Total Quantity:</label><input type="text" id="pm-total-qty" class="history-field"></div>
                <div class="form-group"><label for="pm-receiving-date">Receiving Date:</label><input type="date" id="pm-receiving-date" class="history-field"></div>
                <div class="form-group"><label for="pm-test-date">Test Date:</label><input type="date" id="pm-test-date" class="history-field"></div>
                <div class="form-group"><label for="pm-release-date">Release Date:</label><input type="date" id="pm-release-date" class="history-field"></div>
                <div class="form-group"><label for="pm-supplier">Origin/Supplier:</label><input type="text" id="pm-supplier" class="history-field"></div>
                <div class="form-group"><label for="pm-remarks">Remarks:</label><input type="text" id="pm-remarks" class="remarks-input history-field"></div>
            </div>
        </div>

        <!-- Finished Product Form -->
        <div id="finished-product-form" class="form-wrapper hidden">
            <h2>In-Process / Finished Product Details</h2>
             <div class="form-section">
                <div class="form-group"><label for="fp-sop-approved">Release Doc No:</label><input type="text" id="fp-sop-approved" class="sop-input" value="MP/QC/SOP/002/G"></div>
                <div class="form-group"><label for="fp-sop-rejected">Reject Doc No:</label><input type="text" id="fp-sop-rejected" class="sop-input" value="MP/QC/SOP/002/H"></div>
            </div>
            <div class="form-section">
                <div class="form-group"><label for="fp-qc-no">QC #:</label><input type="text" id="fp-qc-no" class="history-field"></div>
                <div class="form-group"><label for="fp-product-name">Product Name:</label><input type="text" id="fp-product-name" class="history-field"></div>
                <div class="form-group"><label for="fp-batch-no">Batch #:</label><input type="text" id="fp-batch-no" class="history-field"></div>
                <div class="form-group"><label for="fp-mfg-date">MFG Date:</label><input type="date" id="fp-mfg-date" class="history-field"></div>
                <div class="form-group"><label for="fp-exp-date">EXP Date:</label><input type="date" id="fp-exp-date" class="history-field"></div>
                <div class="form-group"><label for="fp-batch-size">Batch Size:</label><input type="text" id="fp-batch-size" class="history-field"></div>
                <div class="form-group"><label for="fp-test-date">Test Date:</label><input type="date" id="fp-test-date" class="history-field"></div>
                <div class="form-group"><label for="fp-release-date">Release Date:</label><input type="date" id="fp-release-date" class="history-field"></div>
                <div class="form-group"><label for="fp-remarks">Remarks:</label><input type="text" id="fp-remarks" class="remarks-input history-field"></div>
            </div>
            <div class="form-section">
                <div class="form-group">
                    <label for="fp-params-select">Select Test Parameters:</label>
                    <select id="fp-params-select" multiple class="history-field">
                        <option value="pH">pH</option>
                        <option value="Dissolution">Dissolution</option>
                        <option value="Average weight">Average weight</option>
                        <option value="Start of compression">Start of compression</option>
                        <option value="End of compression">End of compression</option>
                        <option value="Start of encapsulation">Start of encapsulation</option>
                        <option value="End of encapsulation">End of encapsulation</option>
                        <option value="Start of filling">Start of filling</option>
                        <option value="End of filling">End of filling</option>
                    </select>
                </div>
                <div id="fp-dynamic-params-container" class="form-group" style="gap: 15px;">
                    <!-- Dynamic input fields will be generated here -->
                </div>
            </div>
        </div>

        <div class="button-container">
            <button id="generate-tags">Generate Tags</button>
        </div>
    </div>
    
    <div id="print-area"></div>

    <!-- Firebase Libraries -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <!-- Firebase Configuration -->
    <script src="firebase-config.js"></script>

    <!-- ==== REVISED AND DEBUGGED SCRIPT ==== -->
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // Check if Firebase is initialized correctly
            if (typeof firebase === 'undefined' || typeof firebase.firestore === 'undefined') {
                alert('Firebase is not configured correctly. Please check your firebase-config.js file and ensure it is included.');
                console.error("Firebase not initialized.");
                return;
            }
            const db = firebase.firestore();

            // --- ALL APP LOGIC IS WRAPPED IN A MAIN FUNCTION TO ENSURE DB IS READY ---
            mainApp(db);
        });

        function mainApp(db) {
            // --- PAGE INITIALIZATION ---
            loadLocalData(); // For local data like company name/logo
            setDefaultDates();
            setupEventListeners(db);
            toggleFormVisibility(); 
            listenForHistoryUpdates(db); // Connect to Firebase for history
            autoFillTagsToPrint();
        }

        // --- EVENT LISTENERS SETUP ---
        function setupEventListeners(db) {
            document.getElementById('label-type').addEventListener('change', toggleFormVisibility);
            document.getElementById('tag-status').addEventListener('change', updateThemeAndRemarks);
            document.getElementById('company-name').addEventListener('input', saveLocalData);
            document.getElementById('logo-upload').addEventListener('change', handleLogoUpload);
            document.querySelectorAll('.sop-input').forEach(input => input.addEventListener('input', saveLocalData));
            document.getElementById('generate-tags').addEventListener('click', () => prepareAndPrint());
            
            document.getElementById('fp-params-select').addEventListener('change', () => generateDynamicParamInputs('fp'));
            document.getElementById('rm-params-select').addEventListener('change', () => generateDynamicParamInputs('rm'));

            document.getElementById('total-container-count').addEventListener('input', autoFillTagsToPrint);

            document.getElementById('btn-save-history').addEventListener('click', () => saveToHistory(db));
            document.getElementById('btn-load-history').addEventListener('click', () => loadFromHistory(db));
            document.getElementById('btn-delete-history').addEventListener('click', () => deleteFromHistory(db));

            window.addEventListener('afterprint', cleanupAfterPrint);
        }
        
        // --- HISTORY FUNCTIONALITY (FIREBASE) ---
        function listenForHistoryUpdates(db) {
            const select = document.getElementById('history-select');
            db.collection('labelHistory').orderBy('productName').onSnapshot(snapshot => {
                const selectedValue = select.value;
                select.innerHTML = '<option value="">-- Select an entry --</option>'; // Default option
                if (snapshot.empty) {
                    select.innerHTML += '<option disabled>No history saved yet</option>';
                    return;
                }
                snapshot.forEach(doc => {
                    const data = doc.data();
                    const displayText = `${data.productName} - ${data.batchNumber}`;
                    select.innerHTML += `<option value="${doc.id}">${displayText}</option>`;
                });
                // Restore selection if it still exists
                if (Array.from(select.options).some(opt => opt.value === selectedValue)) {
                    select.value = selectedValue;
                }
            }, error => {
                console.error("Error listening to history updates: ", error);
                select.innerHTML = '<option style="color:red;">Error loading history. Check permissions.</option>';
            });
        }

        async function saveToHistory(db) {
            const currentForm = document.querySelector('.form-wrapper:not(.hidden)');
            if (!currentForm) return;

            const productNameInput = currentForm.querySelector('input[id$="-product-name"], input[id$="-item-name"]');
            const batchNoInput = currentForm.querySelector('input[id$="-batch-no"], input[id$="-batch-lot-no"]');
            const productName = productNameInput ? productNameInput.value.trim() : '';
            const batchNumber = batchNoInput ? batchNoInput.value.trim() : '';

            if (!productName || !batchNumber) {
                alert('Please enter at least a Product Name and Batch Number to save to history.');
                return;
            }

            const historyData = {
                labelType: document.getElementById('label-type').value,
                productName: productName,
                batchNumber: batchNumber,
                createdAt: new Date(),
                fields: {}
            };

            currentForm.querySelectorAll('.history-field').forEach(field => {
                if (field.tagName === 'SELECT' && field.multiple) {
                    historyData.fields[field.id] = Array.from(field.selectedOptions).map(opt => opt.value);
                } else if (field.classList.contains('dynamic-param')) {
                     if (!historyData.fields.dynamicParams) historyData.fields.dynamicParams = {};
                     historyData.fields.dynamicParams[field.dataset.paramName] = field.value;
                }
                else {
                    historyData.fields[field.id] = field.value;
                }
            });
            
            try {
                await db.collection('labelHistory').add(historyData);
                alert(`Entry "${productName} - ${batchNumber}" saved successfully!`);
            } catch (error) {
                console.error("Error saving history to Firebase: ", error);
                alert("Failed to save history. Check console for details.");
            }
        }

        async function loadFromHistory(db) {
            const select = document.getElementById('history-select');
            const historyId = select.value;
            if (!historyId) {
                alert('Please select an entry to load.');
                return;
            }
            
            try {
                const docRef = db.collection('labelHistory').doc(historyId);
                const docSnap = await docRef.get();

                if (!docSnap.exists()) {
                    alert("Could not find the selected history entry. It may have been deleted.");
                    return;
                }
                const dataToLoad = docSnap.data();
                
                document.getElementById('label-type').value = dataToLoad.labelType;
                toggleFormVisibility();

                // Use a short delay to ensure the correct form is visible before populating it
                setTimeout(() => {
                    for (const fieldId in dataToLoad.fields) {
                        const field = document.getElementById(fieldId);
                        if (field) {
                            if (field.tagName === 'SELECT' && field.multiple) {
                                const values = dataToLoad.fields[fieldId] || [];
                                Array.from(field.options).forEach(opt => {
                                    opt.selected = values.includes(opt.value);
                                });
                            } else {
                                field.value = dataToLoad.fields[fieldId];
                            }
                        }
                    }
                    if (dataToLoad.fields.dynamicParams) {
                        const prefix = dataToLoad.labelType === 'raw-material' ? 'rm' : 'fp';
                        generateDynamicParamInputs(prefix, dataToLoad.fields.dynamicParams);
                    } else {
                        document.getElementById('fp-dynamic-params-container').innerHTML = '';
                        document.getElementById('rm-dynamic-params-container').innerHTML = '';
                    }
                }, 100);
            } catch (error) {
                console.error("Error loading history from Firebase: ", error);
                alert("Failed to load history. Check console for details.");
            }
        }

        async function deleteFromHistory(db) {
            const select = document.getElementById('history-select');
            const historyId = select.value;
            if (!historyId) {
                alert('Please select an entry to delete.');
                return;
            }

            const selectedText = select.options[select.selectedIndex].text;
            if (confirm(`Are you sure you want to delete "${selectedText}"?`)) {
                try {
                    await db.collection('labelHistory').doc(historyId).delete();
                    alert('Entry deleted.');
                } catch (error) {
                    console.error("Error deleting history from Firebase: ", error);
                    alert("Failed to delete history. Check console for details.");
                }
            }
        }

        // --- LOCAL DATA HANDLING (COMPANY NAME/LOGO, SOPs) ---
        function handleLogoUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = e => {
                const logoDataUrl = e.target.result;
                document.getElementById('logo-preview').src = logoDataUrl;
                localStorage.setItem('companyLogo', logoDataUrl);
            }
            reader.readAsDataURL(file);
        }

        function saveLocalData() {
            localStorage.setItem('companyName', document.getElementById('company-name').value);
            document.querySelectorAll('.sop-input').forEach(input => {
                localStorage.setItem(input.id, input.value);
            });
        }

        function loadLocalData() {
            document.getElementById('company-name').value = localStorage.getItem('companyName') || '';
            document.getElementById('logo-preview').src = localStorage.getItem('companyLogo') || 'data:image/gif;base64,R0lGODlhAQABAAD/ACwAAAAAAQABAAACADs=';
            document.querySelectorAll('.sop-input').forEach(input => {
                input.value = localStorage.getItem(input.id) || input.value;
            });
        }
        
        // --- DATA GATHERING HELPER ---
        function getActiveFormData() {
            const data = { dynamicParams: {} };
            const activeForm = document.querySelector('.form-wrapper:not(.hidden)');
            if (!activeForm) return null;

            // Get standard fields
            activeForm.querySelectorAll('.history-field:not(.dynamic-param):not([multiple])').forEach(input => {
                const key = input.id.substring(input.id.indexOf('-') + 1);
                data[key] = input.value;
            });

            // Get dynamic parameter fields
            activeForm.querySelectorAll('.dynamic-param').forEach(input => {
                data.dynamicParams[input.dataset.paramName] = input.value;
            });
            
            return data;
        }

        // --- UI AND PRINTING LOGIC ---
        function prepareAndPrint() {
            console.log("Generate Tags button clicked."); // For debugging
            const labelType = document.getElementById('label-type').value;
            const tagStatus = document.getElementById('tag-status').value;
            const totalContainers = parseInt(document.getElementById('total-container-count').value, 10) || 0;
            const tagsToPrintStr = document.getElementById('tags-to-print').value;
            
            if (totalContainers <= 0) { alert('Please enter a valid "Total # of Containers".'); return; }
            if (!tagsToPrintStr) { alert('Please enter the container numbers to print.'); return; }
            
            const containerNumbers = parseTagNumbers(tagsToPrintStr);
            if (containerNumbers.length === 0) { alert('Invalid format for "Container #s to Print".'); return; }
            
            const data = getActiveFormData();
            if (!data) { alert("Error: Could not find the active form data."); return; }

            const companyLogo = document.getElementById('logo-preview').src;
            const sopPrefix = { 'raw-material': 'rm', 'packing-material': 'pm', 'finished-product': 'fp' }[labelType];
            const sopStatusSuffix = tagStatus === 'released' ? 'approved' : tagStatus;
            const sopInputId = `${sopPrefix}-sop-${sopStatusSuffix}`;
            const sopInput = document.getElementById(sopInputId);

            if (!sopInput && (labelType !== 'packing-material' || tagStatus !== 'sampled')) {
                alert(`Error: Could not find document number field with ID: ${sopInputId}`);
                return; 
            }
            const sopNumber = sopInput ? sopInput.value : '';
            
            let tagsHtml = '';
            for (const containerNum of containerNumbers) {
                 if (containerNum > totalContainers || containerNum < 1) continue;
                tagsHtml += buildTagHtml(labelType, data, tagStatus, sopNumber, companyLogo, containerNum, totalContainers);
            }
            
            document.body.classList.add('is-printing');
            document.getElementById('print-area').innerHTML = `<div class="print-container">${tagsHtml}</div>`;
            window.print();
        }

        function parseTagNumbers(inputString) {
            const numbers = new Set();
            if (!inputString) return [];
            const parts = inputString.split(',');
            for (const part of parts) {
                const trimmedPart = part.trim();
                if (trimmedPart.includes('-')) {
                    const [start, end] = trimmedPart.split('-').map(num => parseInt(num.trim(), 10));
                    if (!isNaN(start) && !isNaN(end) && end >= start) {
                        for (let i = start; i <= end; i++) numbers.add(i);
                    }
                } else {
                    const num = parseInt(trimmedPart, 10);
                    if (!isNaN(num)) numbers.add(num);
                }
            }
            return Array.from(numbers).sort((a, b) => a - b);
        }

        function autoFillTagsToPrint() {
            const total = document.getElementById('total-container-count').value;
            const tagsInput = document.getElementById('tags-to-print');
            tagsInput.value = (parseInt(total, 10) > 0) ? `1-${total}` : '';
        }
        
        function updateThemeAndRemarks() {
            const status = document.getElementById('tag-status').value;
            const container = document.getElementById('main-container');
            container.className = 'container no-print';
            container.classList.add(`theme-${status}`);
            const currentForm = document.querySelector('.form-wrapper:not(.hidden)');
            if (currentForm) {
                const remarksInput = currentForm.querySelector('.remarks-input');
                if (status === 'rejected') {
                    remarksInput.value = 'Result does not comply with specifications';
                } else if (status === 'sampled') {
                    remarksInput.value = 'Sampled for analysis';
                } else {
                    const labelType = document.getElementById('label-type').value;
                    remarksInput.value = labelType === 'finished-product' ? 'Release for' : 'Result complies with specification';
                }
            }
        }

        function toggleFormVisibility() {
            const selectedType = document.getElementById('label-type').value;
            document.querySelectorAll('.form-wrapper').forEach(form => {
                form.classList.toggle('hidden', form.id !== `${selectedType}-form`);
            });
            const sampledOption = document.getElementById('sampled-option');
            const tagStatusSelect = document.getElementById('tag-status');
            if (selectedType === 'raw-material') {
                sampledOption.style.display = 'block';
            } else {
                sampledOption.style.display = 'none';
                if (tagStatusSelect.value === 'sampled') tagStatusSelect.value = 'released';
            }
            updateThemeAndRemarks();
        }

        function setDefaultDates() {
            const today = new Date().toISOString().split('T')[0];
            document.querySelectorAll('input[type="date"]').forEach(input => {
                if (!input.value) input.value = today;
            });
        }

        function formatDate(dateString) {
            if (!dateString || dateString.toLowerCase() === 'n/a') return dateString;
            try {
                const [year, month, day] = dateString.split('-');
                if (!day || !month || !year) return dateString;
                return `${day}.${month}.${year}`;
            } catch (e) { return dateString; }
        }

        function generateDynamicParamInputs(prefix, savedParams = {}) {
            const select = document.getElementById(`${prefix}-params-select`);
            const container = document.getElementById(`${prefix}-dynamic-params-container`);
            container.innerHTML = '';
            const selectedOptions = Array.from(select.selectedOptions);
            for (const option of selectedOptions) {
                const paramName = option.value;
                const paramId = `${prefix}-param-${paramName.replace(/\s+/g, '-')}`;
                const value = savedParams[paramName] || '';
                const group = document.createElement('div');
                group.className = 'form-group';
                group.innerHTML = `<label for="${paramId}">${paramName}:</label><input type="text" id="${paramId}" class="history-field dynamic-param" value="${value}" data-param-name="${paramName}">`;
                container.appendChild(group);
            }
        }

        function cleanupAfterPrint() {
            document.body.classList.remove('is-printing');
            document.getElementById('print-area').innerHTML = '';
        }
        
        function buildTagHtml(type, data, status, sop, companyLogo, currentContainer, totalContainers) {
            let statusText, statusColor, headerTitle;
            switch (status) {
                case 'released': statusText = 'APPROVED'; statusColor = 'green'; break;
                case 'rejected': statusText = 'REJECTED'; statusColor = 'red'; break;
                case 'sampled': statusText = 'SAMPLED'; statusColor = '#007bff'; break;
            }
            let subtitle, bodyHtml;
            let dynamicFieldsHtml = '';
            for(const paramName in data.dynamicParams) {
                if(data.dynamicParams[paramName]) { 
                    dynamicFieldsHtml += `<div class="field"><span class="field-label">${paramName}:</span><span class="field-value">${data.dynamicParams[paramName]}</span></div>`;
                }
            }
            switch (type) {
                case 'raw-material':
                    headerTitle = statusText;
                    subtitle = '(Raw Material)';
                    bodyHtml = `<div class="field"><span class="field-label">QC #:</span><span class="field-value">${data['qc-no'] || ''}</span></div><div class="field"><span class="field-label">Container#:</span><span class="field-value">${currentContainer}/${totalContainers}</span></div><div class="field remarks-field"><span class="field-label">PRODUCT NAME:</span><span class="field-value">${data['product-name'] || ''}</span></div><div class="field"><span class="field-label">BATCH #:</span><span class="field-value">${data['batch-no'] || ''}</span></div><div class="field"><span class="field-label">MFG DATE:</span><span class="field-value">${data['mfg-date'] || ''}</span></div><div class="field"><span class="field-label">EXP. DATE:</span><span class="field-value">${data['exp-date'] || ''}</span></div><div class="field"><span class="field-label">BATCH SIZE:</span><span class="field-value">${data['batch-size'] || ''}</span></div><div class="field"><span class="field-label">TEST DATE:</span><span class="field-value">${formatDate(data['test-date'])}</span></div><div class="field"><span class="field-label">RELEASE DATE:</span><span class="field-value">${formatDate(data['release-date'])}</span></div>${dynamicFieldsHtml}<div class="field remarks-field"><span class="field-label">MANUFACTURER:</span><span class="field-value">${data['manufacturer'] || ''}</span></div><div class="field remarks-field"><span class="field-label">REMARKS:</span><span class="field-value">${data['remarks'] || ''}</span></div>`;
                    break;
                case 'packing-material':
                    headerTitle = statusText;
                    subtitle = '(Packing Material)';
                    bodyHtml = `<div class="field"><span class="field-label">QC #:</span><span class="field-value">${data['qc-no'] || ''}</span></div><div class="field"><span class="field-label">Container#:</span><span class="field-value">${currentContainer}/${totalContainers}</span></div><div class="field remarks-field"><span class="field-label">ITEM NAME:</span><span class="field-value">${data['item-name'] || ''}</span></div><div class="field"><span class="field-label">TOTAL QTY:</span><span class="field-value">${data['total-qty'] || ''}</span></div><div class="field"><span class="field-label">BATCH LOT #:</span><span class="field-value">${data['batch-lot-no'] || ''}</span></div><div class="field"><span class="field-label">RECEIVING DT:</span><span class="field-value">${formatDate(data['receiving-date'])}</span></div><div class="field"><span class="field-label">TEST DATE:</span><span class="field-value">${formatDate(data['test-date'])}</span></div><div class="field"><span class="field-label">RELEASE DATE:</span><span class="field-value">${formatDate(data['release-date'])}</span></div><div class="field remarks-field"><span class="field-label">SUPPLIER:</span><span class="field-value">${data['supplier'] || ''}</span></div><div class="field remarks-field"><span class="field-label">REMARKS:</span><span class="field-value">${data['remarks'] || ''}</span></div>`;
                    break;
                case 'finished-product':
                    headerTitle = (status === 'released') ? 'RELEASED' : 'REJECTED';
                    subtitle = '(Bulk / In-Process / Finished Product)';
                    bodyHtml = `<div class="field"><span class="field-label">QC #:</span><span class="field-value">${data['qc-no'] || ''}</span></div><div class="field"><span class="field-label">Container#:</span><span class="field-value">${currentContainer}/${totalContainers}</span></div><div class="field remarks-field"><span class="field-label">PRODUCT NAME:</span><span class="field-value">${data['product-name'] || ''}</span></div><div class="field"><span class="field-label">BATCH #:</span><span class="field-value">${data['batch-no'] || ''}</span></div><div class="field"><span class="field-label">MFG DATE:</span><span class="field-value">${formatDate(data['mfg-date'])}</span></div><div class="field"><span class="field-label">EXP DATE:</span><span class="field-value">${formatDate(data['exp-date'])}</span></div><div class="field"><span class="field-label">BATCH SIZE:</span><span class="field-value">${data['batch-size'] || ''}</span></div><div class="field"><span class="field-label">TEST DATE:</span><span class="field-value">${formatDate(data['test-date'])}</span></div><div class="field"><span class="field-label">RELEASE DATE:</span><span class="field-value">${formatDate(data['release-date'])}</span></div>${dynamicFieldsHtml}<div class="field remarks-field"><span class="field-label">REMARKS:</span><span class="field-value">${data['remarks'] || ''}</span></div>`;
                    break;
            }
            return `<div class="tag"><div><div class="tag-header"><div class="logo-area"><img src="${companyLogo}" alt="Logo"></div><div class="title-block"><h3 style="color: ${statusColor};">${headerTitle}</h3><p class="subtitle">${subtitle}</p></div><div class="sop-block">${sop}</div></div><div class="tag-body">${bodyHtml}</div></div><div class="tag-footer"><div>QC/ANALYST:</div></div></div>`;
        }
    </script>

</body>
</html>